{# This is an HTML fragment returned for AJAX requests #}
{# It does NOT extend base.html #}

<div class="results-header">
    <h2>Matching Trains</h2>
    <span class="results-count">{{ matches.len() }} match{% if matches.len() != 1 %}es{% endif %}</span>
</div>

<div class="search-context">
    <p>
        Trains arriving at <strong>{{ next_station }}</strong>
        {% if let Some(term) = terminus %}
        terminating at <strong>{{ term }}</strong>
        {% endif %}
    </p>
</div>

{% if matches.is_empty() %}
<div class="empty-state">
    <h3>No Matching Trains Found</h3>
    <p>No trains found matching your criteria. This could mean:</p>
    <ul>
        <li>Your train has already departed from {{ next_station }}</li>
        <li>The station codes might be incorrect</li>
        <li>There's a service disruption</li>
    </ul>
    <p>Try checking the next station along your route, or verify the terminus.</p>
</div>
{% else %}

{% if matches.len() == 1 %}
{% for m in matches %}
{% if m.is_exact %}
<div class="info-banner success">
    <p>Found your train! Confirm to plan onward connections.</p>
</div>
{% endif %}
{% endfor %}
{% else if matches.len() > 1 %}
<div class="info-banner">
    <p>Multiple trains match your criteria. Select the one you're on, or verify using the RTT link.</p>
</div>
{% endif %}

<div class="service-list">
    {% for m in matches %}
    <article class="service-card{% if m.service.is_cancelled %} cancelled{% endif %}{% if m.is_exact %} exact-match{% endif %}">
        <header class="service-header">
            <div class="service-identity">
                <span class="service-time{% if m.is_arrival_delayed() %} delayed{% endif %}">
                    {{ m.display_arrival() }}
                    {% if m.is_arrival_delayed() %}
                    <span class="original">{{ m.scheduled_arrival }}</span>
                    {% endif %}
                </span>
                {% if let Some(headcode) = m.service.headcode %}
                <span class="headcode">{{ headcode }}</span>
                {% endif %}
            </div>

            <div class="service-destination">
                <h3>{{ m.next_station_name }}</h3>
                <span class="service-terminus">
                    arr. {{ m.terminus_name }}
                    <span class="terminus-time{% if m.is_terminus_delayed() %} delayed{% endif %}">
                        {{ m.display_terminus_arrival() }}
                        {% if m.is_terminus_delayed() %}
                        <span class="original">({{ m.scheduled_terminus_arrival }})</span>
                        {% endif %}
                    </span>
                </span>
            </div>

            {% if let Some(platform) = m.service.platform %}
            <div class="service-platform">
                <span class="platform-label">Platform</span>
                <span class="platform-number">{{ platform }}</span>
            </div>
            {% endif %}
        </header>

        <div class="service-status-row">
            {% if m.service.is_cancelled %}
            <span class="service-status cancelled">Cancelled</span>
            {% else if m.is_arrival_delayed() %}
            <span class="service-status delayed">Delayed</span>
            {% else %}
            <span class="service-status on-time">On Time</span>
            {% endif %}

            {% if m.is_exact %}
            <span class="match-badge exact">Exact Match</span>
            {% else %}
            <span class="match-badge partial">Partial Match</span>
            {% endif %}

            <a href="{{ m.rtt_url }}" target="_blank" rel="noopener" class="rtt-link">
                Verify on RTT
            </a>
        </div>

        {% if !m.service.is_cancelled %}
        <div class="confirm-train-row">
            <button type="button"
                    class="btn btn-primary select-position-btn"
                    data-service-id="{{ m.service.service_id }}"
                    data-position-idx="{{ m.board_station_idx }}"
                    data-board-station="{{ next_station }}">
                Yes, I'm on this train
            </button>
        </div>
        {% endif %}

        <div class="calling-points">
            <p class="calling-points-summary">{{ m.service.calling_points_summary() }}</p>
            <button type="button" class="calling-points-toggle">
                <span class="arrow">&#9654;</span>
                Show times
            </button>

            <div class="calling-points-list">
                {% for call in m.service.calls %}
                <div class="calling-point{% if call.is_cancelled %} cancelled{% endif %}">
                    <div class="calling-point-time">
                        {{ call.display_time() }}
                        {% if call.is_delayed() %}
                        <span class="delayed">(was {{ call.scheduled_time }})</span>
                        {% endif %}
                    </div>
                    <div class="calling-point-name">
                        {{ call.name }}
                        <span class="calling-point-crs">({{ call.crs }})</span>
                    </div>
                    {% if let Some(platform) = call.platform %}
                    <div class="calling-point-platform">
                        <span>Plat. {{ platform }}</span>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
    </article>
    {% endfor %}
</div>
{% endif %}
