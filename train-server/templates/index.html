{% extends "base.html" %}

{% block title %}Continuing Journey Planner{% endblock %}

{% block content %}
<div class="search-panel">
    <form id="identify-form" action="/identify" method="GET">
        <div class="form-row">
            <div class="form-group">
                <label for="next_station">Next Stop</label>
                <div class="autocomplete-wrapper">
                    <input type="text" id="next_station" name="next_station"
                           placeholder="e.g. WDB or Woodbridge"
                           required
                           autocomplete="off"
                           data-autocomplete="station">
                    <div class="autocomplete-dropdown" data-for="next_station"></div>
                </div>
                <p class="hint">The next station your train will call at</p>
            </div>

            <div class="form-group">
                <label for="terminus">Terminates At (Optional)</label>
                <div class="autocomplete-wrapper">
                    <input type="text" id="terminus" name="terminus"
                           placeholder="e.g. IPS or Ipswich"
                           autocomplete="off"
                           data-autocomplete="station">
                    <div class="autocomplete-dropdown" data-for="terminus"></div>
                </div>
                <p class="hint">Where your train terminates</p>
            </div>
        </div>

        <button type="submit" class="btn btn-primary btn-block">
            Identify My Train
        </button>
    </form>

    <div class="destination-section">
        <div class="form-group">
            <label for="destination">Where Are You Going?</label>
            <div class="autocomplete-wrapper">
                <input type="text" id="destination"
                       placeholder="e.g. BRI or Bristol Temple Meads"
                       autocomplete="off"
                       data-autocomplete="station">
                <div class="autocomplete-dropdown" data-for="destination"></div>
            </div>
            <p class="hint">Your final destination</p>
        </div>

        <button type="button" id="plan-journey-btn" class="btn btn-primary btn-block" disabled>
            Plan Journey
        </button>
    </div>
</div>

<div id="train-matches-container">
    <!-- Train matches will be inserted here -->
</div>

<div id="journey-results-container">
    <!-- Journey results will be inserted here -->
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
    'use strict';

    const identifyForm = document.getElementById('identify-form');
    const trainMatchesContainer = document.getElementById('train-matches-container');
    const journeyResultsContainer = document.getElementById('journey-results-container');
    const destinationInput = document.getElementById('destination');
    const planJourneyBtn = document.getElementById('plan-journey-btn');

    // Track selected train state
    let selectedTrain = null;

    // ========================================
    // STATION AUTOCOMPLETE
    // ========================================

    // Track active autocomplete state per input
    const autocompleteState = new Map();

    // Debounce helper
    function debounce(fn, delay) {
        let timer = null;
        return function() {
            const args = arguments;
            const context = this;
            clearTimeout(timer);
            timer = setTimeout(function() {
                fn.apply(context, args);
            }, delay);
        };
    }

    // Fetch station suggestions
    async function fetchStations(query) {
        if (!query || query.length < 1) return [];
        try {
            const response = await fetch('/api/stations/search?q=' + encodeURIComponent(query) + '&limit=8');
            if (!response.ok) return [];
            const data = await response.json();
            return data.stations || [];
        } catch (e) {
            return [];
        }
    }

    // Render dropdown items
    function renderDropdown(dropdown, stations, selectedIndex) {
        dropdown.innerHTML = stations.map(function(station, idx) {
            const selectedClass = idx === selectedIndex ? ' selected' : '';
            return '<div class="autocomplete-item' + selectedClass + '" tabindex="0" data-crs="' + station.crs + '" data-name="' + station.name.replace(/"/g, '&quot;') + '">' +
                '<span class="autocomplete-crs">' + station.crs + '</span>' +
                '<span class="autocomplete-station-name">(' + station.name + ')</span>' +
                '</div>';
        }).join('');
    }

    // Try to auto-select if input value is a valid 3-letter CRS code
    function tryAutoSelect(input, state) {
        if (!state || state.stations.length === 0) return;

        const query = input.value.trim().toUpperCase();
        if (query.length !== 3) return;

        const match = state.stations.find(function(s) {
            return s.crs === query;
        });
        if (match) {
            input.value = match.crs + ' (' + match.name + ')';
        }
    }

    // Close all dropdowns (with auto-select for any valid CRS codes)
    function closeAllDropdowns() {
        autocompleteState.forEach(function(state, inputId) {
            const input = document.getElementById(inputId);
            if (input) {
                tryAutoSelect(input, state);
            }
        });
        document.querySelectorAll('.autocomplete-dropdown').forEach(function(dd) {
            dd.innerHTML = '';
        });
        autocompleteState.clear();
    }

    // Handle input on autocomplete fields
    const handleInput = debounce(async function(e) {
        const input = e.target;
        const inputId = input.id;
        const dropdown = document.querySelector('.autocomplete-dropdown[data-for="' + inputId + '"]');
        if (!dropdown) return;

        const query = input.value.trim();

        // Clear dropdown if query is too short
        if (query.length < 1) {
            dropdown.innerHTML = '';
            autocompleteState.delete(inputId);
            return;
        }

        // Fetch and display suggestions
        const stations = await fetchStations(query);
        autocompleteState.set(inputId, { stations: stations, selectedIndex: -1 });
        renderDropdown(dropdown, stations, -1);
    }, 150);

    // Handle keyboard navigation
    function handleKeydown(e) {
        const input = e.target;
        const inputId = input.id;
        const dropdown = document.querySelector('.autocomplete-dropdown[data-for="' + inputId + '"]');
        if (!dropdown) return;

        const state = autocompleteState.get(inputId);
        if (!state || state.stations.length === 0) return;

        if (e.key === 'ArrowDown') {
            e.preventDefault();
            state.selectedIndex = Math.min(state.selectedIndex + 1, state.stations.length - 1);
            renderDropdown(dropdown, state.stations, state.selectedIndex);
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            state.selectedIndex = Math.max(state.selectedIndex - 1, -1);
            renderDropdown(dropdown, state.stations, state.selectedIndex);
        } else if (e.key === 'Enter' && state.selectedIndex >= 0) {
            e.preventDefault();
            const selected = state.stations[state.selectedIndex];
            input.value = selected.crs + ' (' + selected.name + ')';
            dropdown.innerHTML = '';
            autocompleteState.delete(inputId);
        } else if (e.key === 'Escape') {
            dropdown.innerHTML = '';
            autocompleteState.delete(inputId);
        }
    }

    // Handle click on dropdown item
    function handleDropdownClick(e) {
        const item = e.target.closest('.autocomplete-item');
        if (!item) return;

        const dropdown = item.closest('.autocomplete-dropdown');
        const inputId = dropdown.dataset.for;
        const input = document.getElementById(inputId);
        if (!input) return;

        input.value = item.dataset.crs + ' (' + item.dataset.name + ')';
        dropdown.innerHTML = '';
        autocompleteState.delete(inputId);
        input.focus();
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.autocomplete-wrapper')) {
            closeAllDropdowns();
        }
    });

    // Initialize autocomplete on all station inputs
    document.querySelectorAll('input[data-autocomplete="station"]').forEach(function(input) {
        input.addEventListener('input', handleInput);
        input.addEventListener('keydown', handleKeydown);
    });

    // Handle clicks and keyboard on dropdown items
    document.querySelectorAll('.autocomplete-dropdown').forEach(function(dropdown) {
        dropdown.addEventListener('click', handleDropdownClick);
        dropdown.addEventListener('keydown', function(e) {
            const item = e.target.closest('.autocomplete-item');
            if (!item) return;

            const items = Array.from(dropdown.querySelectorAll('.autocomplete-item'));
            const currentIndex = items.indexOf(item);
            const inputId = dropdown.dataset.for;
            const input = document.getElementById(inputId);

            if (e.key === 'Tab') {
                // Tab should leave the dropdown entirely, not move between items
                // The focusout handler will take care of auto-select
                // Remove tabindex temporarily so Tab skips remaining items
                items.forEach(function(i) { i.removeAttribute('tabindex'); });
                // Focus will naturally move to next focusable element
            } else if (e.key === 'ArrowDown' && currentIndex < items.length - 1) {
                e.preventDefault();
                items[currentIndex + 1].focus();
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                if (currentIndex > 0) {
                    items[currentIndex - 1].focus();
                } else if (input) {
                    input.focus();
                }
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (input) {
                    input.value = item.dataset.crs + ' (' + item.dataset.name + ')';
                    dropdown.innerHTML = '';
                    autocompleteState.delete(inputId);
                    input.focus();
                }
            } else if (e.key === 'Escape') {
                dropdown.innerHTML = '';
                autocompleteState.delete(inputId);
                if (input) input.focus();
            }
        });
    });

    // Auto-select when focus leaves the autocomplete wrapper entirely
    document.querySelectorAll('.autocomplete-wrapper').forEach(function(wrapper) {
        wrapper.addEventListener('focusout', function(e) {
            // Check if focus is moving to something still inside this wrapper
            if (e.relatedTarget && wrapper.contains(e.relatedTarget)) {
                return;
            }

            // Focus is leaving the wrapper entirely - auto-select and close
            // Small delay to handle edge cases with click handlers
            setTimeout(function() {
                const input = wrapper.querySelector('input[data-autocomplete="station"]');
                if (!input) return;

                const inputId = input.id;
                const state = autocompleteState.get(inputId);
                if (state) {
                    tryAutoSelect(input, state);
                    const dropdown = wrapper.querySelector('.autocomplete-dropdown');
                    if (dropdown) dropdown.innerHTML = '';
                    autocompleteState.delete(inputId);
                }
            }, 50);
        });
    });

    // ========================================
    // PLAN JOURNEY BUTTON STATE
    // ========================================

    function updatePlanJourneyButtonState() {
        const hasDestination = extractCrs(destinationInput.value).length >= 3;
        const hasSelection = selectedTrain !== null;
        planJourneyBtn.disabled = !(hasDestination && hasSelection);
    }

    // Update button state when destination changes
    destinationInput.addEventListener('input', function() {
        updatePlanJourneyButtonState();
    });
    destinationInput.addEventListener('change', function() {
        updatePlanJourneyButtonState();
    });

    // ========================================
    // FORM SUBMISSION
    // ========================================

    // Extract CRS code from display value like "WDB (Woodbridge)"
    function extractCrs(value) {
        const trimmed = value.trim();
        // If it contains a space, take the first word (the CRS code)
        const spaceIdx = trimmed.indexOf(' ');
        if (spaceIdx > 0) {
            return trimmed.substring(0, spaceIdx).toUpperCase();
        }
        return trimmed.toUpperCase();
    }

    // Handle identify form submission
    identifyForm.addEventListener('submit', function(e) {
        e.preventDefault();

        // Close any open dropdowns
        closeAllDropdowns();

        const formData = new FormData(identifyForm);
        const params = new URLSearchParams();

        // Fields that contain station codes (may have display names appended)
        const stationFields = ['next_station', 'terminus'];

        // Only add non-empty values
        for (const [key, value] of formData.entries()) {
            if (value.trim()) {
                if (stationFields.includes(key)) {
                    params.append(key, extractCrs(value));
                } else {
                    params.append(key, value.trim().toUpperCase());
                }
            }
        }

        // Clear selection and journey results
        selectedTrain = null;
        journeyResultsContainer.innerHTML = '';
        updatePlanJourneyButtonState();

        // Show loading state
        trainMatchesContainer.innerHTML = '<div class="loading"><div class="loading-spinner"></div><p class="loading-text">Identifying your train...</p></div>';

        // Fetch results
        fetch('/identify?' + params.toString(), {
            headers: {
                'Accept': 'text/html'
            }
        })
        .then(function(response) {
            if (!response.ok) {
                throw new Error('Request failed');
            }
            return response.text();
        })
        .then(function(html) {
            trainMatchesContainer.innerHTML = html;
            initializeCallingPointToggles();
            initializeTrainSelection();
        })
        .catch(function(error) {
            trainMatchesContainer.innerHTML = '<div class="error-message"><h3>Request Failed</h3><p>Unable to fetch results. Please check your input and try again.</p></div>';
        });
    });

    // Initialize calling point toggles for dynamically loaded content
    function initializeCallingPointToggles() {
        trainMatchesContainer.querySelectorAll('.calling-points-toggle').forEach(function(toggle) {
            toggle.addEventListener('click', function() {
                const list = toggle.nextElementSibling;
                toggle.classList.toggle('expanded');
                list.classList.toggle('visible');
            });
        });
    }

    // Initialize train selection radio buttons
    function initializeTrainSelection() {
        trainMatchesContainer.querySelectorAll('input[name="selected-train"]').forEach(function(radio) {
            radio.addEventListener('change', function() {
                // Update selected train state
                selectedTrain = {
                    serviceId: radio.value,
                    positionIdx: radio.dataset.positionIdx,
                    boardStation: radio.dataset.boardStation
                };

                // Update visual selection on cards
                trainMatchesContainer.querySelectorAll('.service-card').forEach(function(card) {
                    card.classList.remove('selected');
                });
                const card = radio.closest('.service-card');
                if (card) {
                    card.classList.add('selected');
                }

                updatePlanJourneyButtonState();
            });
        });
    }

    // ========================================
    // JOURNEY PLANNING
    // ========================================

    planJourneyBtn.addEventListener('click', function() {
        if (!selectedTrain) return;

        const destination = destinationInput.value.trim();
        if (!destination) {
            destinationInput.focus();
            return;
        }

        // Show loading
        journeyResultsContainer.innerHTML = '<div class="loading"><div class="loading-spinner"></div><p class="loading-text">Planning your journey...</p></div>';

        // Submit journey plan request
        fetch('/journey/plan', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'text/html'
            },
            body: JSON.stringify({
                service_id: selectedTrain.serviceId,
                position: parseInt(selectedTrain.positionIdx),
                destination: extractCrs(destination),
                board_station: selectedTrain.boardStation
            })
        })
        .then(function(response) {
            if (!response.ok) {
                return response.text().then(function(text) {
                    throw new Error(text);
                });
            }
            return response.text();
        })
        .then(function(html) {
            journeyResultsContainer.innerHTML = html;
        })
        .catch(function(error) {
            journeyResultsContainer.innerHTML = '<div class="error-message"><h3>Planning Failed</h3><p>' + (error.message || 'Unable to plan journey. Please try again.') + '</p></div>';
        });
    });
})();
</script>
{% endblock %}
