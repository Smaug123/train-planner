{% extends "base.html" %}

{% block title %}Continuing Journey Planner{% endblock %}

{% block content %}
<div class="hero">
    <h1>Continuing Journey Planner</h1>
    <p class="subtitle">Already on a train? Find your best onward connection.</p>
</div>

<div class="poster-banner">
    <p>Where will the railway take you today?</p>
</div>

<div class="illustration-placeholder">
    <img src="/static/optimistic_train.png" alt="A 1930s-style poster illustration of a streamlined locomotive emerging from green countryside hills, running alongside a river, with an idyllic village church in the distance, and two people waving at the train from the foreground.">
</div>

<div class="search-panel">
    <h2>Already on a Train?</h2>

    <form id="identify-form" action="/identify" method="GET">
        <div class="form-row">
            <div class="form-group">
                <label for="next_station">Next Stop</label>
                <input type="text" id="next_station" name="next_station"
                       placeholder="e.g. WDB"
                       required
                       maxlength="3"
                       autocomplete="off">
                <p class="hint">The next station your train will call at</p>
            </div>

            <div class="form-group">
                <label for="terminus">Terminates At (Optional)</label>
                <input type="text" id="terminus" name="terminus"
                       placeholder="e.g. IPS"
                       maxlength="3"
                       autocomplete="off">
                <p class="hint">Where your train terminates</p>
            </div>
        </div>

        <button type="submit" class="btn btn-primary btn-block">
            Identify My Train
        </button>
    </form>
</div>

<div class="search-panel">
    <h2>Search by Departure Station</h2>

    <form id="search-form" action="/search/service" method="GET">
        <div class="form-group">
            <label for="origin">Departed From</label>
            <input type="text" id="origin" name="origin"
                   placeholder="e.g. PAD or London Paddington"
                   required
                   autocomplete="off">
            <p class="hint">Enter a station code (3 letters) or name</p>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="headcode">Headcode (Optional)</label>
                <input type="text" id="headcode" name="headcode"
                       placeholder="e.g. 1A23"
                       pattern="[0-9][A-Za-z][0-9]{2}"
                       maxlength="4"
                       autocomplete="off">
            </div>

            <div class="form-group">
                <label for="dep_time">Departure Time</label>
                <input type="time" id="dep_time" name="time">
            </div>
        </div>

        <p class="hint">Provide headcode or departure time to narrow down results. If both are given, headcode takes priority.</p>

        <div class="form-group">
            <label for="destination">Final Destination (Optional)</label>
            <input type="text" id="destination" name="destination"
                   placeholder="e.g. BRI or Bristol Temple Meads"
                   autocomplete="off">
            <p class="hint">Enter your final destination to filter services</p>
        </div>

        <button type="submit" class="btn btn-primary btn-block">
            Find Service
        </button>
    </form>
</div>

<div id="results-container">
    <!-- Search results will be inserted here -->
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
    'use strict';

    const searchForm = document.getElementById('search-form');
    const identifyForm = document.getElementById('identify-form');
    const resultsContainer = document.getElementById('results-container');

    // Generic form submission handler
    function submitForm(form, endpoint, loadingMessage) {
        const formData = new FormData(form);
        const params = new URLSearchParams();

        // Only add non-empty values
        for (const [key, value] of formData.entries()) {
            if (value.trim()) {
                params.append(key, value.trim().toUpperCase());
            }
        }

        // Show loading state
        resultsContainer.innerHTML = `
            <div class="loading">
                <div class="loading-spinner"></div>
                <p class="loading-text">${loadingMessage}</p>
            </div>
        `;

        // Fetch results
        fetch(endpoint + '?' + params.toString(), {
            headers: {
                'Accept': 'text/html'
            }
        })
        .then(function(response) {
            if (!response.ok) {
                throw new Error('Request failed');
            }
            return response.text();
        })
        .then(function(html) {
            resultsContainer.innerHTML = html;
            initializeCallingPointToggles();
        })
        .catch(function(error) {
            resultsContainer.innerHTML = `
                <div class="error-message">
                    <h3>Request Failed</h3>
                    <p>Unable to fetch results. Please check your input and try again.</p>
                </div>
            `;
        });
    }

    // Handle identify form submission
    identifyForm.addEventListener('submit', function(e) {
        e.preventDefault();
        submitForm(identifyForm, '/identify', 'Identifying your train...');
    });

    // Handle search form submission
    searchForm.addEventListener('submit', function(e) {
        e.preventDefault();
        submitForm(searchForm, '/search/service', 'Searching for services...');
    });

    // Initialize calling point toggles for dynamically loaded content
    function initializeCallingPointToggles() {
        document.querySelectorAll('.calling-points-toggle').forEach(function(toggle) {
            toggle.addEventListener('click', function() {
                const list = toggle.nextElementSibling;
                toggle.classList.toggle('expanded');
                list.classList.toggle('visible');
            });
        });
    }

    // Handle position selection for journey planning
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('select-position-btn')) {
            const btn = e.target;
            const serviceId = btn.dataset.serviceId;
            const positionIdx = btn.dataset.positionIdx;
            const boardStation = btn.dataset.boardStation;

            // Show destination prompt
            const destination = prompt('Enter your final destination (station code or name):');
            if (!destination) return;

            // Show loading
            resultsContainer.innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p class="loading-text">Planning your journey...</p>
                </div>
            `;

            // Submit journey plan request
            fetch('/journey/plan', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'text/html'
                },
                body: JSON.stringify({
                    service_id: serviceId,
                    position: parseInt(positionIdx),
                    destination: destination.trim(),
                    board_station: boardStation
                })
            })
            .then(function(response) {
                if (!response.ok) {
                    return response.text().then(function(text) {
                        throw new Error(text);
                    });
                }
                return response.text();
            })
            .then(function(html) {
                resultsContainer.innerHTML = html;
            })
            .catch(function(error) {
                resultsContainer.innerHTML = `
                    <div class="error-message">
                        <h3>Planning Failed</h3>
                        <p>${error.message || 'Unable to plan journey. Please try again.'}</p>
                    </div>
                `;
            });
        }
    });
})();
</script>
{% endblock %}
